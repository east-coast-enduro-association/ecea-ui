---
import BaseLayout from "../layouts/BaseLayout.astro";
import PageHeader from "../components/Sections/PageHeader.astro";
import { getCollection, getEntry } from "astro:content";
import { MOTO_TALLY } from "../utils/constants";

// Get all events to determine which years have events for each type
const allEvents = await getCollection("events", ({ data }) => {
  return !data.draft;
});

// Get team results for current year summary
const teamResults2025 = await getEntry("teamResults", "2025");
const teamData = teamResults2025?.data;
const topTeams = teamData?.standings.slice(0, 5) || [];

// Get clubs collection for slug mapping
const clubs = await getCollection("clubs");
const clubSlugMap = Object.fromEntries(
  clubs.map(club => [club.data.abbreviatedName, club.id])
);

// Competitive event types that use Moto-Tally
const competitiveTypes = [
  { name: "Enduro", path: MOTO_TALLY.paths["Enduro"] },
  { name: "Hare Scramble", path: MOTO_TALLY.paths["Hare Scramble"] },
  { name: "FastKIDZ", path: MOTO_TALLY.paths["FastKIDZ"] },
];

// Get years for each event type
const resultsByType = competitiveTypes.map(type => {
  const years = [...new Set(
    allEvents
      .filter(e => e.data.eventType === type.name)
      .map(e => new Date(e.data.date).getFullYear())
  )].sort((a, b) => b - a); // Most recent first

  return {
    ...type,
    years,
    getResultsUrl: (year: number) =>
      `${MOTO_TALLY.baseUrl}/${type.path}/${MOTO_TALLY.pages.results}?EY=${year}`,
    getStandingsUrl: () =>
      `${MOTO_TALLY.baseUrl}/${type.path}/${MOTO_TALLY.pages.standings}`,
  };
});
---

<BaseLayout
  title="Results - ECEA"
  description="View race results for ECEA Enduros, Hare Scrambles, and FastKIDZ events."
>
  <PageHeader
    title="Race Results"
    subtitle="View results from ECEA championship events"
    backgroundImage="/images/feature-bg.jpg"
  />

  <section class="py-12">
    <div class="container">
      <div class="max-w-4xl mx-auto">
        <p class="text-gray-600 mb-8 text-center">
          Results are hosted on Moto-Tally. Select an event type and year to view results.
        </p>

        <div class="grid gap-8">
          {resultsByType.map((type) => (
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
              <div class="bg-gray-900 px-6 py-4 flex items-center justify-between">
                <h2 class="text-xl font-bold text-white">{type.name} Results</h2>
                <a
                  href={type.getStandingsUrl()}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="inline-flex items-center px-3 py-1.5 bg-white/10 hover:bg-white/20 text-white text-sm rounded-lg transition-colors font-medium"
                >
                  Championship Standings
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5 ml-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                  </svg>
                </a>
              </div>

              <div class="p-6">
                {type.years.length > 0 ? (
                  <div class="flex flex-wrap gap-3">
                    {type.years.map((year) => (
                      <a
                        href={type.getResultsUrl(year)}
                        target="_blank"
                        rel="noopener noreferrer"
                        class="inline-flex items-center px-4 py-2 bg-primary-50 text-primary-700 rounded-lg hover:bg-primary-100 transition-colors font-medium"
                      >
                        {year}
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                        </svg>
                      </a>
                    ))}
                  </div>
                ) : (
                  <p class="text-gray-500 italic">No results available</p>
                )}
              </div>
            </div>
          ))}
        </div>

        <!-- Team Competition -->
        {teamData && (
          <div class="mt-8 bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
            <div class="bg-amber-600 px-6 py-4 flex items-center justify-between">
              <h2 class="text-xl font-bold text-white">Enduro Team Competition</h2>
              <a
                href="/results/team"
                class="inline-flex items-center px-3 py-1.5 bg-white/10 hover:bg-white/20 text-white text-sm rounded-lg transition-colors font-medium"
              >
                Full Standings
                <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5 ml-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
              </a>
            </div>

            <div class="p-6">
              <p class="text-sm text-gray-600 mb-4">
                {teamData.year} Club Team Championship
                <span class="ml-2 px-2 py-0.5 bg-amber-100 text-amber-800 text-xs rounded">Unofficial</span>
              </p>

              <div class="space-y-2">
                {topTeams.map((team, idx) => (
                  <div class="flex items-center justify-between py-2 border-b border-gray-100 last:border-0">
                    <div class="flex items-center gap-3">
                      <span class={`inline-flex items-center justify-center w-7 h-7 rounded-full text-sm font-bold ${
                        idx === 0 ? 'bg-amber-400 text-amber-900' :
                        idx === 1 ? 'bg-gray-300 text-gray-700' :
                        idx === 2 ? 'bg-amber-600 text-white' :
                        'bg-gray-100 text-gray-600'
                      }`}>
                        {team.place}
                      </span>
                      {clubSlugMap[team.club] ? (
                        <a href={`/clubs/${clubSlugMap[team.club]}`} class="font-bold text-gray-900 hover:text-primary-600 transition-colors">{team.club}</a>
                      ) : (
                        <span class="font-bold text-gray-900">{team.club}</span>
                      )}
                    </div>
                    <span class="font-bold text-primary-700">{team.total} pts</span>
                  </div>
                ))}
              </div>

              <a
                href="/results/team"
                class="mt-4 inline-flex items-center text-primary-600 hover:text-primary-700 font-medium text-sm"
              >
                View all teams & event results
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
              </a>
            </div>
          </div>
        )}

        <div class="mt-12 p-6 bg-gray-50 rounded-lg">
          <h3 class="font-bold text-gray-900 mb-2">Looking for something specific?</h3>
          <p class="text-gray-600 mb-4">
            You can also find results by visiting individual event pages. Past events include
            direct links to their start grid and results on Moto-Tally.
          </p>
          <a href="/events" class="text-primary-600 hover:text-primary-700 font-medium inline-flex items-center">
            Browse All Events
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
            </svg>
          </a>
        </div>
      </div>
    </div>
  </section>
</BaseLayout>

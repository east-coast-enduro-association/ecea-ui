---
import BaseLayout from "../../layouts/BaseLayout.astro";
import PageHeader from "../../components/Sections/PageHeader.astro";
import { getCollection, getEntry } from "astro:content";

// Get team results data
const teamResults2025 = await getEntry("teamResults", "2025");
const data = teamResults2025?.data;

// Get clubs collection for full names and slugs
const clubs = await getCollection("clubs");
const clubNameMap = Object.fromEntries(
  clubs.map(club => [club.data.abbreviatedName, club.data.name])
);
const clubSlugMap = Object.fromEntries(
  clubs.map(club => [club.data.abbreviatedName, club.id])
);

// Sort events by date for display
const completedEvents = data?.events
  .filter(e => e.completed)
  .sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime()) || [];

// Points scale for reference
const pointsScale = [
  { place: 1, points: 25 },
  { place: 2, points: 22 },
  { place: 3, points: 20 },
  { place: 4, points: 18 },
  { place: 5, points: 16 },
  { place: 6, points: 15 },
  { place: 7, points: 14 },
  { place: 8, points: 13 },
  { place: 9, points: 12 },
  { place: 10, points: 11 },
];

// Helper to format date
const formatDate = (dateStr: string) => {
  const date = new Date(dateStr);
  return date.toLocaleDateString("en-US", { month: "short", day: "numeric" });
};

// Helper to get result display
const getResultDisplay = (result: number | "W" | null) => {
  if (result === "W") return { text: "W", class: "bg-amber-100 text-amber-800", title: "Host Club" };
  if (result === null) return { text: "-", class: "text-gray-300", title: "Did not compete" };
  if (result === 0) return { text: "0", class: "text-gray-400", title: "0 points" };
  return { text: String(result), class: "text-gray-900 font-medium", title: `${result} points` };
};

// Get event results for a specific event
const getEventResults = (eventAbbr: string) => {
  if (!data) return [];
  return data.standings
    .map(standing => ({
      club: standing.club,
      result: standing.results[eventAbbr],
    }))
    .filter(r => r.result !== null && r.result !== "W")
    .sort((a, b) => {
      const aVal = typeof a.result === "number" ? a.result : 0;
      const bVal = typeof b.result === "number" ? b.result : 0;
      return bVal - aVal;
    });
};
---

<BaseLayout
  title="Team Results - ECEA"
  description="ECEA Enduro Series Club Team Competition results and standings."
>
  <PageHeader
    title="Team Competition"
    subtitle="ECEA Enduro Series Club Team Results"
    backgroundImage="/images/feature-bg.jpg"
  />

  <section class="py-12">
    <div class="container">
      {data ? (
        <div class="space-y-12">

          <!-- Championship Standings -->
          <div>
            <div class="flex items-center justify-between mb-6">
              <div>
                <h2 class="text-2xl font-bold text-gray-900">{data.year} Championship Standings</h2>
                <p class="text-gray-600 text-sm mt-1">
                  Last updated: {new Date(data.lastUpdated).toLocaleDateString("en-US", { month: "long", day: "numeric", year: "numeric" })}
                  <span class="ml-2 px-2 py-0.5 bg-amber-100 text-amber-800 text-xs rounded">Unofficial</span>
                </p>
              </div>
            </div>

            <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
              <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                  <thead class="bg-gray-900">
                    <tr>
                      <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider sticky left-0 bg-gray-900 text-white z-10">Pos</th>
                      <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider sticky left-12 bg-gray-900 text-white z-10">Club</th>
                      <th class="px-4 py-3 text-center text-xs font-semibold uppercase tracking-wider bg-primary-700 text-white">Total</th>
                      {data.events.map(event => (
                        <th class={`px-3 py-3 text-center text-xs font-medium uppercase tracking-wider whitespace-nowrap ${event.completed ? 'text-white' : 'text-gray-500'}`}>
                          <div title={event.name}>{event.abbr}</div>
                          <div class="text-[10px] font-normal normal-case text-gray-400">{formatDate(event.date)}</div>
                        </th>
                      ))}
                    </tr>
                  </thead>
                  <tbody class="bg-white divide-y divide-gray-200">
                    {data.standings.map((standing, idx) => (
                      <tr class={idx < 3 ? "bg-amber-50/50" : idx % 2 === 0 ? "bg-white" : "bg-gray-50"}>
                        <td class="px-4 py-3 whitespace-nowrap text-sm font-bold text-gray-900 sticky left-0 bg-inherit z-10">
                          {standing.place <= 3 ? (
                            <span class={`inline-flex items-center justify-center w-6 h-6 rounded-full ${
                              standing.place === 1 ? 'bg-amber-400 text-amber-900' :
                              standing.place === 2 ? 'bg-gray-300 text-gray-700' :
                              'bg-amber-600 text-white'
                            }`}>
                              {standing.place}
                            </span>
                          ) : standing.place}
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap sticky left-12 bg-inherit z-10">
                          {clubSlugMap[standing.club] ? (
                            <a href={`/clubs/${clubSlugMap[standing.club]}`} class="group">
                              <div class="text-sm font-bold text-gray-900 group-hover:text-primary-600 transition-colors">{standing.club}</div>
                              <div class="text-xs text-gray-500">{clubNameMap[standing.club] || ''}</div>
                            </a>
                          ) : (
                            <>
                              <div class="text-sm font-bold text-gray-900">{standing.club}</div>
                              <div class="text-xs text-gray-500">{clubNameMap[standing.club] || ''}</div>
                            </>
                          )}
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-center text-sm font-bold text-primary-700 bg-primary-50">
                          {standing.total}
                        </td>
                        {data.events.map(event => {
                          const result = standing.results[event.abbr];
                          const display = getResultDisplay(result);
                          return (
                            <td class={`px-3 py-3 whitespace-nowrap text-center text-sm ${display.class}`} title={display.title}>
                              {display.text}
                            </td>
                          );
                        })}
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>

            <!-- Legend -->
            <div class="mt-4 flex flex-wrap gap-4 text-sm text-gray-600">
              <div class="flex items-center gap-2">
                <span class="px-2 py-0.5 bg-amber-100 text-amber-800 rounded text-xs font-medium">W</span>
                <span>Host Club (cannot earn points)</span>
              </div>
              <div class="flex items-center gap-2">
                <span class="text-gray-300">-</span>
                <span>Did not compete</span>
              </div>
              <div>All events count (no throw-aways)</div>
            </div>
          </div>

          <!-- Individual Event Results -->
          <div>
            <h2 class="text-2xl font-bold text-gray-900 mb-6">Event Results</h2>

            <div class="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
              {completedEvents.map(event => {
                const eventResults = getEventResults(event.abbr);
                return (
                  <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                    <div class="bg-gray-900 px-4 py-3">
                      <h3 class="font-bold text-white">{event.name}</h3>
                      <p class="text-sm text-gray-300">
                        {new Date(event.date).toLocaleDateString("en-US", { month: "long", day: "numeric", year: "numeric" })}
                        <span class="ml-2 text-xs opacity-70">Hosted by {event.abbr}</span>
                      </p>
                    </div>
                    <div class="p-4">
                      {eventResults.length > 0 ? (
                        <table class="w-full text-sm">
                          <thead>
                            <tr class="text-xs text-gray-500 uppercase">
                              <th class="text-left pb-2">Pos</th>
                              <th class="text-left pb-2">Club</th>
                              <th class="text-right pb-2">Points</th>
                            </tr>
                          </thead>
                          <tbody class="divide-y divide-gray-100">
                            {eventResults.slice(0, 10).map((r, idx) => (
                              <tr>
                                <td class="py-1.5 font-medium text-gray-600">{idx + 1}</td>
                                <td class="py-1.5 font-medium">
                                  {clubSlugMap[r.club] ? (
                                    <a href={`/clubs/${clubSlugMap[r.club]}`} class="text-gray-900 hover:text-primary-600 transition-colors">{r.club}</a>
                                  ) : (
                                    <span class="text-gray-900">{r.club}</span>
                                  )}
                                </td>
                                <td class="py-1.5 text-right text-primary-700 font-bold">{r.result}</td>
                              </tr>
                            ))}
                          </tbody>
                        </table>
                      ) : (
                        <p class="text-gray-500 italic text-sm">No team results recorded</p>
                      )}
                      {eventResults.length > 10 && (
                        <p class="text-xs text-gray-500 mt-2">+ {eventResults.length - 10} more teams</p>
                      )}
                    </div>
                  </div>
                );
              })}
            </div>
          </div>

          <!-- Points Scale Reference -->
          <div class="bg-gray-50 rounded-lg p-6">
            <h3 class="font-bold text-gray-900 mb-4">Points Scale</h3>
            <div class="flex flex-wrap gap-3">
              {pointsScale.map(({ place, points }) => (
                <div class="flex items-center gap-2 bg-white px-3 py-1.5 rounded border">
                  <span class="text-sm text-gray-600">{place}{place === 1 ? 'st' : place === 2 ? 'nd' : place === 3 ? 'rd' : 'th'}</span>
                  <span class="font-bold text-primary-700">{points}</span>
                </div>
              ))}
              <span class="text-sm text-gray-500 self-center">... down to 20th = 1 point</span>
            </div>
          </div>

          <!-- Download Links -->
          <div class="bg-gray-100 rounded-lg p-6">
            <h3 class="font-bold text-gray-900 mb-2">PDF Downloads</h3>
            <p class="text-sm text-gray-600 mb-4">Original PDF files are still available for download.</p>
            <div class="flex flex-wrap gap-3">
              <a
                href="/attachments/events/team-results/2025-en-current-team-results.pdf"
                class="inline-flex items-center px-4 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors text-sm font-medium"
                download
              >
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                2025 Standings (PDF)
              </a>
              <a
                href="/attachments/events/team-results/2024/2024-en-team-championship-results.pdf"
                class="inline-flex items-center px-4 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors text-sm font-medium"
                download
              >
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                2024 Final Results (PDF)
              </a>
            </div>
          </div>

        </div>
      ) : (
        <p class="text-gray-500 italic">No team results data available.</p>
      )}
    </div>
  </section>
</BaseLayout>

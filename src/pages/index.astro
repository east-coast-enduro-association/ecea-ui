---
import BaseLayout from "../layouts/BaseLayout.astro";
import Button from "../components/UI/Button.astro";
import { Image } from "astro:assets";
import { getCollection } from "astro:content";
import { formatDate } from "../utils/dateUtils";
import heroBg from "@assets/images/feature-bg.jpg";

// Sponsor images
import kendaLogo from "@assets/images/sponsors/kenda1.png";
import amsoilLogo from "@assets/images/sponsors/amsoil-logo.png";
import hundredPercentLogo from "@assets/images/sponsors/100percent.png";
import araiLogo from "@assets/images/sponsors/arai.png";
import blackrockLogo from "@assets/images/sponsors/blackrock-synthetics.png";
import dpBrakesLogo from "@assets/images/sponsors/dp-brakes-logo.png";
import evansCoolantLogo from "@assets/images/sponsors/evans-coolant.png";
import funnelwebLogo from "@assets/images/sponsors/funnelweb-logo.png";
import liquimolyLogo from "@assets/images/sponsors/liquimoly.png";
import revzillaLogo from "@assets/images/sponsors/revzilla.png";
import vpFuelsLogo from "@assets/images/sponsors/vp-fuels.jpg";

// Sponsor data
const titleSponsor = { name: "Kenda Tires", logo: kendaLogo, url: "#" };
const sponsors = [
  { name: "AMSOIL", logo: amsoilLogo, url: "#" },
  { name: "100%", logo: hundredPercentLogo, url: "#" },
  { name: "Arai", logo: araiLogo, url: "#" },
  { name: "Blackrock Synthetics", logo: blackrockLogo, url: "#" },
  { name: "DP Brakes", logo: dpBrakesLogo, url: "#" },
  { name: "Evans Coolant", logo: evansCoolantLogo, url: "#" },
  { name: "Funnelweb", logo: funnelwebLogo, url: "#" },
  { name: "Liqui Moly", logo: liquimolyLogo, url: "#" },
  { name: "RevZilla", logo: revzillaLogo, url: "#" },
  { name: "VP Fuels", logo: vpFuelsLogo, url: "#" },
];

// Get upcoming events
const allEvents = await getCollection("events", ({ data }) => {
  return !data.draft && new Date(data.date) >= new Date();
});
const upcomingEvents = allEvents
  .sort((a, b) => new Date(a.data.date).getTime() - new Date(b.data.date).getTime())
  .slice(0, 4);

// Get club logos for events without images
const clubs = await getCollection("clubs");
const clubLogoMap = Object.fromEntries(
  clubs.map(club => [club.data.abbreviatedName, club.data.logo])
);

// Get latest blog posts
const allPosts = await getCollection("blog", ({ data }) => {
  return import.meta.env.PROD ? !data.draft : true;
});
const sortedPosts = allPosts
  .sort((a, b) => new Date(b.data.pubDate).getTime() - new Date(a.data.pubDate).getTime());

// Get latest announcement for the hero
const latestAnnouncement = sortedPosts.find(post => post.data.category === 'announcement');

// Get latest posts for news section (7 posts)
const latestPosts = sortedPosts.slice(0, 7);

// Helper to get event image
const getEventImage = (event: typeof upcomingEvents[0]) => {
  if (event.data.image) return event.data.image;
  if (event.data.hostingClubs?.[0]) {
    return clubLogoMap[event.data.hostingClubs[0]];
  }
  return null;
};
---

<BaseLayout>
  <!-- Hero Section - Option B: Small Card Overlay -->
  <section
    class="relative min-h-[70vh] flex items-center bg-cover bg-center"
    style="background-image: linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.6)), url(/images/feature-bg.jpg);"
  >
    <div class="container">
      <div class="max-w-2xl">
        <h1 class="text-4xl md:text-5xl lg:text-6xl font-bold mb-4 text-white">
          East Coast Enduro Association
        </h1>
        <p class="text-xl md:text-2xl mb-8 text-white/90">
          AMA sanctioned off-road motorcycle racing since 1971
        </p>
        <div class="flex flex-wrap gap-4">
          <Button href="/events" variant="primary" size="lg">
            View Events
          </Button>
          <Button href="/get-started" variant="outline" size="lg" class="bg-white/10 text-white border-white hover:bg-white hover:text-gray-900 backdrop-blur-sm">
            Get Started
          </Button>
        </div>
      </div>
    </div>

    <!-- Featured Announcement Overlay Card -->
    {latestAnnouncement && (
      <a
        href={`/blog/${latestAnnouncement.slug}`}
        class="group absolute bottom-8 right-8 hidden lg:block w-80 bg-black/40 backdrop-blur-lg rounded-xl overflow-hidden border border-white/30 hover:bg-black/50 hover:border-white/50 transition-all duration-300 shadow-2xl"
      >
        <div class="p-5">
          <div class="flex items-center gap-3 mb-3">
            <span class="px-2.5 py-1 bg-accent-600 text-white text-xs font-bold rounded uppercase tracking-wider">
              Announcement
            </span>
            <span class="text-white/80 text-sm">{formatDate(latestAnnouncement.data.pubDate)}</span>
          </div>
          <h3 class="text-lg font-bold text-white group-hover:text-primary-300 transition-colors line-clamp-2 leading-tight">
            {latestAnnouncement.data.title}
          </h3>
          <p class="text-white/70 text-sm mt-2 line-clamp-2">
            {latestAnnouncement.data.description}
          </p>
          <div class="mt-3 flex items-center text-primary-400 text-sm font-medium group-hover:text-primary-300">
            Read more
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-1 transition-transform group-hover:translate-x-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
            </svg>
          </div>
        </div>
      </a>
    )}
  </section>

  <!-- Racing Series - Dark Banner with Button Links -->
  <section class="py-6 bg-gray-900 text-white">
    <div class="container">
      <div class="flex flex-wrap items-center justify-center gap-3 md:gap-4">
        <a href="/series/enduro" class="flex items-center gap-2 px-4 py-2 bg-white/10 hover:bg-white/20 rounded-lg transition-colors">
          <span class="text-lg">üèÅ</span>
          <span class="font-medium">Enduro</span>
        </a>
        <a href="/series/harescramble" class="flex items-center gap-2 px-4 py-2 bg-white/10 hover:bg-white/20 rounded-lg transition-colors">
          <span class="text-lg">üèçÔ∏è</span>
          <span class="font-medium">Hare Scramble</span>
        </a>
        <a href="/series/fastkidz" class="flex items-center gap-2 px-4 py-2 bg-white/10 hover:bg-white/20 rounded-lg transition-colors">
          <span class="text-lg">‚≠ê</span>
          <span class="font-medium">FastKIDZ</span>
        </a>
        <a href="/series/dual-sport" class="flex items-center gap-2 px-4 py-2 bg-white/10 hover:bg-white/20 rounded-lg transition-colors">
          <span class="text-lg">üå≤</span>
          <span class="font-medium">Dual Sport</span>
        </a>
      </div>
    </div>
  </section>

  <!-- Upcoming Events -->
  <section class="py-10 md:py-12 bg-white">
    <div class="container">
      <div class="flex justify-between items-end mb-6">
        <div>
          <span class="text-primary-600 font-medium text-sm uppercase tracking-wider">Coming Up</span>
          <h2 class="text-2xl md:text-3xl font-bold">Upcoming Events</h2>
        </div>
        <a href="/events" class="text-primary-600 font-medium hover:text-primary-700 hidden md:inline-flex items-center">
          All Events
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
          </svg>
        </a>
      </div>

      <!-- Event Cards -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3 md:gap-4">
        {upcomingEvents.slice(0, 4).map((event, index) => {
          const eventImage = getEventImage(event);
          const isFeature = index === 0;

          return (
            <a
              href={`/events/${event.slug}`}
              class:list={[
                "group relative overflow-hidden rounded-xl bg-gray-900",
                isFeature ? "md:row-span-2 aspect-[4/3] md:aspect-auto" : "aspect-[16/9]"
              ]}
            >
              {eventImage ? (
                <Image
                  src={eventImage}
                  alt={event.data.title}
                  class="absolute inset-0 w-full h-full object-cover transition-transform duration-500 group-hover:scale-105"
                  widths={isFeature ? [640, 800] : [400, 600]}
                />
              ) : (
                <div class="absolute inset-0 bg-gradient-to-br from-primary-600 to-primary-800"></div>
              )}

              <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-black/30 to-transparent"></div>

              <div class="absolute bottom-0 left-0 right-0 p-5 md:p-6">
                <div class="flex items-center gap-2 mb-2">
                  <span class="px-2 py-0.5 bg-white/20 backdrop-blur-sm rounded text-xs font-medium text-white uppercase tracking-wider">
                    {event.data.eventType || 'Event'}
                  </span>
                  <span class="text-white/70 text-sm">{formatDate(event.data.date)}</span>
                </div>
                <h3 class:list={[
                  "font-bold text-white group-hover:text-primary-300 transition-colors",
                  isFeature ? "text-xl md:text-2xl" : "text-lg"
                ]}>
                  {event.data.title}
                </h3>
                {isFeature && (
                  <p class="text-white/70 text-sm mt-2 hidden md:block">{event.data.location}</p>
                )}
              </div>
            </a>
          );
        })}
      </div>

      <div class="text-center mt-6 md:hidden">
        <Button href="/events" variant="outline">View All Events</Button>
      </div>
    </div>
  </section>

  <!-- Sponsors Section -->
  <section class="py-8 bg-gray-50 overflow-hidden">
    <div class="container">
      <!-- Title + Title Sponsor inline -->
      <div class="flex flex-col md:flex-row items-center justify-center gap-4 md:gap-8 mb-6">
        <div class="text-center md:text-left">
          <span class="text-primary-600 font-medium text-sm uppercase tracking-wider">Proudly Supported By</span>
          <h2 class="text-xl md:text-2xl font-bold">Our Sponsors</h2>
        </div>
        <div class="hidden md:block w-px h-12 bg-gray-300"></div>
        <a
          href={titleSponsor.url}
          target="_blank"
          rel="noopener noreferrer"
          class="group flex items-center gap-3"
        >
          <span class="text-xs uppercase tracking-wider text-gray-500">Title Sponsor</span>
          <div class="bg-white rounded-lg px-4 py-2 border border-gray-200 group-hover:border-primary-300 transition-colors">
            <Image
              src={titleSponsor.logo}
              alt={titleSponsor.name}
              class="h-10 md:h-12 w-auto object-contain"
            />
          </div>
        </a>
      </div>

      <!-- Sponsor Carousel -->
      <div class="relative">
        <div class="sponsor-carousel flex items-center gap-8 md:gap-12">
          {[...sponsors, ...sponsors].map((sponsor) => (
            <a
              href={sponsor.url}
              target="_blank"
              rel="noopener noreferrer"
              class="flex-shrink-0 grayscale hover:grayscale-0 opacity-60 hover:opacity-100 transition-all duration-300"
            >
              <Image
                src={sponsor.logo}
                alt={sponsor.name}
                class="h-8 md:h-10 w-auto object-contain"
              />
            </a>
          ))}
        </div>
      </div>
    </div>
  </section>

  <style>
    .sponsor-carousel {
      animation: scroll 30s linear infinite;
    }
    .sponsor-carousel:hover {
      animation-play-state: paused;
    }
    @keyframes scroll {
      0% { transform: translateX(0); }
      100% { transform: translateX(-50%); }
    }
  </style>

  <!-- Latest News -->
  <section class="py-10 md:py-12 bg-white">
    <div class="container">
      <div class="flex justify-between items-end mb-6">
        <div>
          <span class="text-primary-600 font-medium text-sm uppercase tracking-wider">News & Updates</span>
          <h2 class="text-2xl md:text-3xl font-bold">Latest News</h2>
        </div>
        <a href="/blog" class="text-primary-600 font-medium hover:text-primary-700 hidden md:inline-flex items-center">
          All Posts
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
          </svg>
        </a>
      </div>

      <!-- Featured + Grid Layout for 7 posts -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 md:gap-4">
        {latestPosts.map((post, index) => {
          const isFeature = index === 0;

          return (
            <a
              href={`/blog/${post.slug}`}
              class:list={[
                "group relative overflow-hidden rounded-xl bg-gray-100",
                isFeature ? "md:col-span-2 lg:col-span-2 aspect-[16/9] md:aspect-[2/1]" : "aspect-[16/9]"
              ]}
            >
              {post.data.image ? (
                <Image
                  src={post.data.image.src}
                  alt={post.data.image.alt}
                  class="absolute inset-0 w-full h-full object-cover transition-transform duration-500 group-hover:scale-105"
                  widths={isFeature ? [640, 800] : [400, 600]}
                />
              ) : (
                <div class="absolute inset-0 bg-gradient-to-br from-gray-700 to-gray-900"></div>
              )}

              <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-black/30 to-transparent"></div>

              <div class="absolute bottom-0 left-0 right-0 p-4 md:p-5">
                <div class="flex items-center gap-2 mb-1">
                  {post.data.category && (
                    <span class:list={[
                      "px-2 py-0.5 text-white text-xs font-medium rounded uppercase tracking-wider",
                      post.data.category === 'announcement' ? 'bg-accent-600' : 'bg-primary-600/80'
                    ]}>
                      {post.data.category}
                    </span>
                  )}
                  <span class="text-white/70 text-sm">{formatDate(post.data.pubDate)}</span>
                </div>
                <h3 class:list={[
                  "font-bold text-white group-hover:text-primary-300 transition-colors",
                  isFeature ? "text-lg md:text-xl" : "text-base md:text-lg line-clamp-2"
                ]}>
                  {post.data.title}
                </h3>
                {isFeature && (
                  <p class="text-white/70 text-sm mt-1 line-clamp-2 hidden md:block">{post.data.description}</p>
                )}
              </div>
            </a>
          );
        })}
      </div>

      <div class="text-center mt-6 md:hidden">
        <Button href="/blog" variant="outline">View All Posts</Button>
      </div>
    </div>
  </section>

  <!-- Compact CTA -->
  <section class="py-10 bg-gray-900 text-white">
    <div class="container">
      <div class="flex flex-col md:flex-row items-center justify-between gap-6 text-center md:text-left">
        <div>
          <h2 class="text-2xl md:text-3xl font-bold text-white">Ready to race?</h2>
          <p class="text-gray-400 mt-1">Join 19+ clubs across the East Coast</p>
        </div>
        <div class="flex flex-wrap justify-center gap-3">
          <Button href="/get-started" variant="primary">
            Get Started
          </Button>
          <Button href="/clubs" variant="outline" class="text-white border-gray-600 hover:bg-gray-800">
            Find a Club
          </Button>
        </div>
      </div>
    </div>
  </section>
</BaseLayout>

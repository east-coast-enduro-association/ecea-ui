---
import BaseLayout from "../../layouts/BaseLayout.astro";
import PostLayout from "../../layouts/PostLayout.astro";
import Button from "../../components/UI/Button.astro";
import { getCollection, getEntry } from "astro:content";
import { formatDate } from "../../utils/dateUtils";
import { getEventMotoTallyUrls } from "../../utils/motoTally";

export async function getStaticPaths() {
  const eventEntries = await getCollection("events");
  return eventEntries.map(entry => ({
    params: { slug: entry.slug },
    props: { entry },
  }));
}

const { entry } = Astro.props;
const { Content } = await entry.render();

// --- IMAGE FALLBACK LOGIC ---
// Priority: 1. Flyer, 2. Event image, 3. Hosting club logo
let displayImage = entry.data.flyer || entry.data.image;
let isFlyer = !!entry.data.flyer; // Track if we're showing a flyer (for full-size display)

// Get clubs collection for logo fallback and slug mapping
const clubs = await getCollection("clubs");
const clubSlugMap = Object.fromEntries(
  clubs.map(club => [club.data.abbreviatedName, club.slug])
);

// If no flyer or image, look up the hosting club's logo
if (!displayImage && entry.data.hostingClubs && entry.data.hostingClubs.length > 0) {
  const hostingClubEntry = clubs.find(c => c.data.abbreviatedName === entry.data.hostingClubs[0]);

  if (hostingClubEntry && hostingClubEntry.data.logo) {
    displayImage = hostingClubEntry.data.logo;
    isFlyer = false; // Club logo should not be displayed full-size
  }
}

// Check if displayImage is an ImageMetadata object (has .src property)
const hasImageMetadata = displayImage && typeof displayImage === 'object' && 'src' in displayImage;

// Get PDF flyer URL for download button (separate from image flyer)
const flyerPdfUrl = entry.data.flyerPdf || null;

// Generate Moto-Tally URLs (auto-calculated from eventType, year, and position)
const allEvents = await getCollection("events");
const motoTallyUrls = getEventMotoTallyUrls(entry, allEvents);

// Use auto-generated URLs if available, otherwise fall back to manual links
const startGridUrl = motoTallyUrls.startGrid || entry.data.startGridLink || null;
const registrationUrl = entry.data.registrationLink || null;
// ----------------------------

const formattedDate = formatDate(entry.data.date);
const formattedEndDate = entry.data.endDate ? formatDate(entry.data.endDate) : null;
const isFutureEvent = new Date(entry.data.date) > new Date();

// Calendar link helpers
const eventDate = new Date(entry.data.date);
const eventEndDate = entry.data.endDate ? new Date(entry.data.endDate) : new Date(eventDate.getTime() + 8 * 60 * 60 * 1000); // Default 8 hours

// Format dates for calendar links (YYYYMMDD or YYYYMMDDTHHmmssZ)
const formatCalDate = (d: Date) => d.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
const formatCalDateOnly = (d: Date) => d.toISOString().slice(0, 10).replace(/-/g, '');

const googleCalUrl = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(entry.data.title)}&dates=${formatCalDate(eventDate)}/${formatCalDate(eventEndDate)}&details=${encodeURIComponent(entry.data.summary || '')}&location=${encodeURIComponent(entry.data.location || '')}`;

// ICS file content for Apple/Outlook
const icsContent = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//ECEA//Events//EN
BEGIN:VEVENT
DTSTART:${formatCalDate(eventDate)}
DTEND:${formatCalDate(eventEndDate)}
SUMMARY:${entry.data.title}
DESCRIPTION:${entry.data.summary || ''}
LOCATION:${entry.data.location || ''}
END:VEVENT
END:VCALENDAR`;
const icsDataUrl = `data:text/calendar;charset=utf-8,${encodeURIComponent(icsContent)}`;

// Google Maps embed URL
const mapsSearchUrl = entry.data.location ? `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(entry.data.location)}` : null;
const mapsEmbedUrl = entry.data.location ? `https://www.google.com/maps?q=${encodeURIComponent(entry.data.location)}&output=embed` : null;

// Team Results (for Enduro events)
let teamEventResults: Array<{ club: string; points: number }> = [];
let teamEventInfo: { abbr: string; name: string } | null = null;

if (entry.data.eventType === "Enduro" && entry.data.hostingClubs?.[0]) {
  const teamResults2025 = await getEntry("teamResults", "2025");
  if (teamResults2025?.data) {
    const hostingClub = entry.data.hostingClubs[0];
    // Find the event in team results by matching hosting club
    const teamEvent = teamResults2025.data.events.find(e => e.abbr === hostingClub);

    if (teamEvent?.completed) {
      teamEventInfo = { abbr: teamEvent.abbr, name: teamEvent.name };
      // Get results for this event (results is now an array of {event, points})
      teamEventResults = teamResults2025.data.standings
        .map(standing => {
          const eventResult = standing.results.find(r => r.event === hostingClub);
          const points = eventResult?.points ? parseInt(eventResult.points, 10) : 0;
          return { club: standing.club, result: points };
        })
        .filter(r => r.result > 0)
        .sort((a, b) => b.result - a.result)
        .map(r => ({ club: r.club, points: r.result }));
    }
  }
}
---

<BaseLayout
  title={`${entry.data.title} - ECEA Events`}
  description={entry.data.summary}
  type="article"
>
  <PostLayout
    title={entry.data.title}
    description={entry.data.summary}
    image={hasImageMetadata ? { src: displayImage, alt: entry.data.title } : undefined}
    date={entry.data.date}
    tags={entry.data.tags}
    type="event"
    fullImage={isFlyer}
  >
    <div class="bg-gray-50 rounded-lg p-6 mb-8 border border-gray-100">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

        <div>
          <h3 class="text-lg font-bold mb-3 text-gray-900">Event Details</h3>

          <div class="flex items-center mb-3">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-primary-600 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
            <div>
              <p class="font-medium">{formattedDate}</p>
              {formattedEndDate && <p class="text-sm text-gray-600">to {formattedEndDate}</p>}
            </div>
          </div>

          {entry.data.keyTime && (
            <div class="flex items-center mb-3">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-primary-600 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <p>Key Time: {new Date(entry.data.keyTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</p>
            </div>
          )}

          <div class="flex items-center mb-3">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-primary-600 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
            <p>{entry.data.location}</p>
          </div>
        </div>

        <div>
          <h3 class="text-lg font-bold mb-3 text-gray-900">Hosted By</h3>
          {entry.data.hostingClubs && (
            <div class="flex items-center mb-4">
               <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-primary-600 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
               </svg>
               <p>
                 {entry.data.hostingClubs.map((club, idx) => (
                   <>
                     {idx > 0 && ", "}
                     {clubSlugMap[club] ? (
                       <a href={`/clubs/${clubSlugMap[club]}`} class="text-primary-600 hover:text-primary-700 font-medium">{club}</a>
                     ) : (
                       <span>{club}</span>
                     )}
                   </>
                 ))}
               </p>
            </div>
          )}

          {entry.data.eventType !== "ECEA" && (
            <div class="grid grid-cols-2 gap-4 text-sm mt-4">
              <div class="bg-white p-2 rounded border border-gray-200 text-center">
                <span class="block font-bold text-gray-500 text-xs uppercase">Format</span>
                {entry.data.format || entry.data.eventType}
              </div>
              {entry.data.gateFee && (
                <div class="bg-white p-2 rounded border border-gray-200 text-center">
                  <span class="block font-bold text-gray-500 text-xs uppercase">Gate Fee</span>
                  {entry.data.gateFee}
                </div>
              )}
              <div class="bg-white p-2 rounded border border-gray-200 text-center">
                <span class="block font-bold text-gray-500 text-xs uppercase">Closed Course</span>
                {entry.data.closedCourse ? "Yes" : "No"}
              </div>
              <div class="bg-white p-2 rounded border border-gray-200 text-center">
                <span class="block font-bold text-gray-500 text-xs uppercase">Gas Away</span>
                {entry.data.gasAway ? "Yes" : "No"}
              </div>
            </div>
          )}
        </div>
      </div>

      <div class="mt-6 pt-6 border-t border-gray-200 flex flex-wrap gap-4">
        {/* Show Registration for future events */}
        {isFutureEvent && registrationUrl && (
          <Button href={registrationUrl} target="_blank" variant="primary">
            Register Online
          </Button>
        )}

        {/* Start Grid - always show if available */}
        {startGridUrl && (
          <Button href={startGridUrl} target="_blank" variant={isFutureEvent ? "outline" : "primary"}>
            View Start Grid
          </Button>
        )}

        {/* Results - link to results page for past events */}
        {!isFutureEvent && (
          <Button href="/results" variant="outline">
            View Results
          </Button>
        )}

        {flyerPdfUrl && (
          <Button href={flyerPdfUrl} target="_blank" variant="secondary">
            Download Flyer (PDF)
          </Button>
        )}
      </div>

      <!-- Add to Calendar -->
      {isFutureEvent && (
        <div class="mt-6 pt-6 border-t border-gray-200">
          <h4 class="text-sm font-bold text-gray-700 mb-3">Add to Calendar</h4>
          <div class="flex flex-wrap gap-3">
            <a
              href={googleCalUrl}
              target="_blank"
              rel="noopener noreferrer"
              class="inline-flex items-center px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 transition-colors"
            >
              <svg class="w-4 h-4 mr-2" viewBox="0 0 24 24" fill="currentColor">
                <path d="M19.5 3h-15A1.5 1.5 0 003 4.5v15A1.5 1.5 0 004.5 21h15a1.5 1.5 0 001.5-1.5v-15A1.5 1.5 0 0019.5 3zm-9 15h-3v-6h3v6zm4.5 0h-3v-9h3v9zm4.5 0h-3v-3h3v3z"/>
              </svg>
              Google
            </a>
            <a
              href={icsDataUrl}
              download={`${entry.slug}.ics`}
              class="inline-flex items-center px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 transition-colors"
            >
              <svg class="w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
              </svg>
              Apple / Outlook
            </a>
          </div>
        </div>
      )}
    </div>

    {entry.data.downloads && entry.data.downloads.length > 0 && (
      <div class="mb-8">
        <h3 class="text-xl font-bold mb-4">Event Downloads</h3>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          {entry.data.downloads.map(file => (
            <a href={file.url} target="_blank" class="flex items-center p-4 bg-white border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-500 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
              </svg>
              <span class="font-medium text-primary-700">{file.label}</span>
            </a>
          ))}
        </div>
      </div>
    )}

    <article class="prose prose-lg max-w-none prose-headings:text-gray-900 prose-a:text-primary-600 hover:prose-a:text-primary-700">
      <Content />
    </article>

    <!-- Location Map -->
    {mapsEmbedUrl && (
      <div class="mt-8 mb-8">
        <h3 class="text-xl font-bold mb-4">Location</h3>
        <div class="rounded-lg overflow-hidden border border-gray-200">
          <iframe
            src={mapsEmbedUrl}
            width="100%"
            height="300"
            style="border:0;"
            allowfullscreen=""
            loading="lazy"
            referrerpolicy="no-referrer-when-downgrade"
            title={`Map showing ${entry.data.location}`}
          ></iframe>
        </div>
        <a
          href={mapsSearchUrl}
          target="_blank"
          rel="noopener noreferrer"
          class="inline-flex items-center mt-3 text-primary-600 hover:text-primary-700 text-sm font-medium"
        >
          <svg class="w-4 h-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
          </svg>
          Open in Google Maps
        </a>
      </div>
    )}

    <!-- Team Results (for Enduro events with completed team competition) -->
    {teamEventResults.length > 0 && (
      <div class="mt-8 mb-8">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-xl font-bold">Team Competition Results</h3>
          <a href="/results/team" class="text-sm text-primary-600 hover:text-primary-700 font-medium">
            View Full Standings →
          </a>
        </div>
        <div class="bg-amber-50 rounded-lg border border-amber-200 overflow-hidden">
          <table class="min-w-full">
            <thead class="bg-amber-100">
              <tr>
                <th class="px-4 py-2 text-left text-xs font-semibold text-amber-800 uppercase">Pos</th>
                <th class="px-4 py-2 text-left text-xs font-semibold text-amber-800 uppercase">Club</th>
                <th class="px-4 py-2 text-right text-xs font-semibold text-amber-800 uppercase">Points</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-amber-100">
              {teamEventResults.slice(0, 10).map((result, idx) => (
                <tr class={idx < 3 ? "bg-amber-50" : "bg-white"}>
                  <td class="px-4 py-2 whitespace-nowrap">
                    {idx < 3 ? (
                      <span class={`inline-flex items-center justify-center w-6 h-6 rounded-full text-xs font-bold ${
                        idx === 0 ? 'bg-amber-400 text-amber-900' :
                        idx === 1 ? 'bg-gray-300 text-gray-700' :
                        'bg-amber-600 text-white'
                      }`}>
                        {idx + 1}
                      </span>
                    ) : (
                      <span class="text-gray-600 text-sm">{idx + 1}</span>
                    )}
                  </td>
                  <td class="px-4 py-2 whitespace-nowrap font-medium">
                    {clubSlugMap[result.club] ? (
                      <a href={`/clubs/${clubSlugMap[result.club]}`} class="text-gray-900 hover:text-primary-600 transition-colors">{result.club}</a>
                    ) : (
                      <span class="text-gray-900">{result.club}</span>
                    )}
                  </td>
                  <td class="px-4 py-2 whitespace-nowrap text-right font-bold text-primary-700">{result.points}</td>
                </tr>
              ))}
            </tbody>
          </table>
          {teamEventResults.length > 10 && (
            <div class="px-4 py-2 bg-amber-50 text-sm text-amber-700 text-center border-t border-amber-100">
              + {teamEventResults.length - 10} more teams
            </div>
          )}
        </div>
      </div>
    )}

    <!-- Social Sharing -->
    <div class="mt-8 py-6 border-t border-gray-200">
      <h3 class="text-lg font-bold mb-4">Share This Event</h3>
      <div class="flex space-x-4">
        <a
          href={`https://facebook.com/sharer/sharer.php?u=${Astro.url}`}
          target="_blank"
          rel="noopener noreferrer"
          class="text-gray-600 hover:text-blue-600 transition-colors"
          aria-label="Share on Facebook"
        >
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24">
            <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
          </svg>
        </a>

        <a
          href={`https://twitter.com/intent/tweet?text=${encodeURIComponent(entry.data.title + ' - ' + formattedDate)}&url=${Astro.url}`}
          target="_blank"
          rel="noopener noreferrer"
          class="text-gray-600 hover:text-blue-400 transition-colors"
          aria-label="Share on Twitter"
        >
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24">
            <path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723 10.03 10.03 0 01-3.127 1.184 4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"/>
          </svg>
        </a>

        <a
          href={`mailto:?subject=${encodeURIComponent(entry.data.title)}&body=${encodeURIComponent(`Check out this event: ${entry.data.title} on ${formattedDate} at ${entry.data.location}\n\n${Astro.url}`)}`}
          class="text-gray-600 hover:text-red-500 transition-colors"
          aria-label="Share via Email"
        >
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
          </svg>
        </a>
      </div>
    </div>

    <div class="mt-8 pt-8 border-t border-gray-200">
      <Button href="/events" variant="outline">
        ← Back to Schedule
      </Button>
    </div>
  </PostLayout>
</BaseLayout>
